\documentclass[article]{IEEEtran}

\usepackage{cite}
\usepackage{amsmath,amssymb,amsfonts}
\usepackage{algorithmic}
\usepackage{graphicx}
\usepackage{textcomp}
\usepackage{xcolor}
\usepackage{flushend}
\usepackage{listings}

\usepackage[utf8]{inputenc}
\def\BibTeX{{\rm B\kern-.05em{\sc i\kern-.025em b}\kern-.08em
    T\kern-.1667em\lower.7ex\hbox{E}\kern-.125emX}}
\begin{document}

\title{Processamento de Streams\\Análise a Corridas de Táxis}


\author{\IEEEauthorblockN{André Lopes - 45617 }\\
\and
\IEEEauthorblockN{Nelson Coquenim - 45694}\\
\IEEEauthorblockA{\textit{Departamento de Informática} \\
\textit{Faculdade de Ciências e Tecnologia da Universidade Nova de Lisboa }\\
Almada, Portugal}
}

\maketitle



\section{Introdução}

\section{\textit{Frequent Routes}}

O objectivo desta primeira \textit{query} é achar o \textit{top} 10 das rotas mais frequentes durante um período de 30 minutos. Um rota é representada por uma \textit{cell} inicial e uma \textit{cell} final.

Na Figura \ref{fig:frequentRoutesDiagram} pode se observar a estrutura desta query. Primeiramente efetua-se uma janela deslizante de 30 minutos sobre o input. Finalmente, seleciona-se os 10 resultados com a frequência mais alta.

\begin{figure}[hbtp]
    \centering
        \includegraphics[width=0.4\textwidth]{images/frequentRoutesDiagram}
    \caption{Diagrama da query \textit{Frequent Routes}.}
    \label{fig:frequentRoutesDiagram}
\end{figure}

O código siddhi que implementa esta \textit{query} é o seguinte:

\begin{lstlisting}[language=SQL]
from TaxiSecStr#window.time(30 minutes)
select pickup_grid_x, pickup_grid_y, 
	dropoff_grid_x, dropoff_grid_y,
	count(*) as frequency
group by pickup_grid_x, pickup_grid_y,
 dropoff_grid_x, dropoff_grid_y
order by frequency DESC
insert into RouteFrequencyStr;

from RouteFrequencyStr#window.length(10)
select *
insert into TopFreqRoutesStr;
\end{lstlisting}


\section{\textit{Profitables Areas}}

Nesta query pretende-se identificar, de forma contínua, as áreas que são mais lucrativas para os taxistas. Para tal, o lucro de uma área é definido pelas receitas geradas nessa área a dividir pelo número de táxis vazios nessa mesma área.

A receita gerada numa área é a média das \textit{fare} + \textit{tip} de todas as corridas que originaram nessa área e que acabaram nos 15 minutos seguintes.

O número de táxis vazios num dada área consiste na soma dos táxis que efetuaram uma \textit{dropoff} nessa área mas que após 30 minutos ainda não efetuaram uma \textit{pickup}.

Na Figura \ref{fig:profitablesAreasDiagram} pode-se observar um diagrama que demonstra o fluxo desta \textit{query}.

\begin{figure}[hbtp]
    \centering
        \includegraphics[width=0.4\textwidth]{images/profitableAreasDiagram}
    \caption{Diagrama da query \textit{Profitables Areas}.}
    \label{fig:profitablesAreasDiagram}
\end{figure}

O código siddhi que implementa esta \textit{query} é o seguinte:

\begin{lstlisting}[language=SQL]
from TaxiSecStr#window.time(15 min)
select pickup_grid_x, pickup_grid_y,
   dropoff_grid_x, dropoff_grid_y,
   avg(FareTrip) as profit
group by pickup_grid_x, pickup_grid_y,
   dropoff_grid_x, dropoff_grid_y
insert into ProfitPerAreaStr;

from e1 = TaxiSecStr ->
  TaxiSecStr[medallion == e1.medallion 
  and pickup_datetime 
   - e1.dropoff_datetime > 30 mins]
select ? 
insert into EmptyTaxisStr

 
\end{lstlisting}

\section{\textit{Idle Taxis}}

Neste \textit{use case} espera-se que seja emitido um alerta quando o número de táxis disponíveis torna-se superior ao pretendido. Para tal, deverá ser publicado um aviso quando o tempo de paragem médio (\textit{idle time}) de todos os táxis é superior a 10 minutos. Define-se como tempo de paragem, o período de tempo entre uma \textit{dropoff} e uma \textit{pickup}. Finalmente, assume-se que um táxi encontra-se disponível se tiver realizado pelo menos uma viagem na última hora.

O diagrama na Figura \textbf{INSERIR FIGURA} demonstra a lógica da implementação desta \textit{query}.

Em seguida, apresenta-se o excerto de código da \textit{query} em questão:
\begin{lstlisting}[language=SQL]
from TaxiSecStr#window.time(1 hour)
select *
insert into AvailableTaxisStr;

from e1 = TaxiSecStr -> 
  e2 = TaxiSecStr[medallion==e1.medallion]
select e1.medallion as taxi,
  (e2.p_time-e1.d_time) as idle_time
insert into IdleTimeTaxisStr;

from IdleTimeTaxisStr
select avg(idle_time) as avg_idle_time
having avg_idle_time > 10 * 60
insert into IdleTaxisStr;
\end{lstlisting}


\section{\textit{Congested Areas}}

Nesta secção ir-se-à implementar uma \textit{query} que emita as localizações onde possivelmente poderá haver congestionamentos no trânsito. Para tal, dever-se-á detetar picos nas durações das viagens dos táxis que são seguidos por pelo menos 3 viagens todas estas com durações crescentes.

A Figura \ref{fig:congestedAreasDiagram} expõe o racional na construção desta \textit{query}.

\begin{figure}[hbtp]
    \centering
        \includegraphics[width=0.4\textwidth]{images/congestedAreas}
    \caption{Diagrama da query \textit{Congested Areas}.}
    \label{fig:congestedAreasDiagram}
\end{figure}

Finalmente, apresenta-se o código siddhi da \textit{query} \textit{congested areas}:

\begin{lstlisting}[language=SQL]
from every e1 = TaxiSecStr ->
  e2 = TaxiSecStr[medallion==e1.medallion
  and ride_duration > e1.ride_duration] ->
  e3 = TaxiSecStr[medallion==e2.medallion
  and ride_duration < e2.ride_duration] ->
  e4 = TaxiSecStr[medallion==e3.medallion
  and ride_duration > e3.ride_duration] ->
  e5 = TaxiSecStr[medallion==e4.medallion
  and ride_duration > e4.ride_duration] ->
  e6 = TaxiSecStr[medallion==e5.medallion
  and ride_duration > e5.ride_duration]
select e2.pickup_grid_x as grid_x,
  e2.pickup_grid_y as grid_y
insert into CongestedAreasStr;
\end{lstlisting}



\section{\textit{Most Pleasant Taxi Drivers}}

Para recompensar os condutores de táxis mais simpáticos é necessário que seja emitido, uma vez por dia, o taxista que recebeu mais gorjetas nesse dia.

O fluxo da Figura \ref{fig:pleasantDriverDiagram} demonstra a construção desta \textit{query}.

\begin{figure}[hbtp]
    \centering
        \includegraphics[width=0.4\textwidth]{images/pleasantDriver}
    \caption{Diagrama da query \textit{Most Pleasant Taxi Driver}.}
    \label{fig:pleasantDriverDiagram}
\end{figure}

Por último, no segmento de código seguinte apresenta-se a solução referente a este \textit{use case}:

\begin{lstlisting}[language=SQL]
from TaxiSecStr#window.timeBatch(24 hours)
select driver, 
  sum(tip_amount) as tips_total
group by driver
order by tips_total DESC
insert into TodayDriversTips;

from TodayDriversTips#window.length(1)
select *
insert into PleasantDriverStr;
\end{lstlisting}

\section{Conclusão} 


\bibliography{bibliography}

\bibliographystyle{IEEEtran}
\end{document}
